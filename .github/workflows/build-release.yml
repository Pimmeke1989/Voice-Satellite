name: Build LumiTone Firmware

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ESPHome & ESPTool
        run: |
          pip install esphome esptool

      - name: Create Dummy Secrets
        run: |
          mkdir -p config
          echo "wifi_ssid: \"dummy\"" > config/secrets.yaml
          echo "wifi_password: \"dummy\"" >> config/secrets.yaml
          echo "api_key: \"dummy\"" >> config/secrets.yaml
          echo "ota_password: \"dummy\"" >> config/secrets.yaml

      # We negeren de exit code (|| true) omdat hij vaak faalt op netwerk-checks na de build
      - name: Build Firmware
        run: esphome compile config/voice-factory.yaml || true

      # HIER IS DE MAGIE: We zoeken overal en lijmen het zelf
      - name: Find and Glue Files
        run: |
          echo "--- DEBUG: We tonen de bestandsstructuur om te zien waar alles staat ---"
          # We zoeken tot 4 mappen diep naar bin files om te zien waar ze zijn
          find . -maxdepth 5 -name "*.bin"
          echo "-----------------------------------------------------------------------"

          echo "We gaan de bestanden bij elkaar sprokkelen..."
          
          # Zoek de bestanden, ongeacht in welke submap ze zitten
          # We sorteren op tijd (-t) en pakken de bovenste (head -1) om zeker te zijn dat we de nieuwste hebben
          BOOTLOADER=$(find . -name "bootloader.bin" -type f | head -n 1)
          PARTITIONS=$(find . -name "partitions.bin" -type f | head -n 1)
          BOOT_APP0=$(find . -name "boot_app0.bin" -type f | head -n 1)
          FIRMWARE=$(find . -name "firmware.bin" -type f | head -n 1)

          echo "Gevonden puzzelstukjes:"
          echo "1. Bootloader: $BOOTLOADER"
          echo "2. Partitions: $PARTITIONS"
          echo "3. Boot App0:  $BOOT_APP0"
          echo "4. Firmware:   $FIRMWARE"

          # Veiligheidscheck
          if [ -z "$FIRMWARE" ]; then
            echo "CRITISCH: Geen firmware.bin gevonden. De build is waarschijnlijk toch echt mislukt."
            exit 1
          fi

          if [ -z "$BOOTLOADER" ] || [ -z "$PARTITIONS" ]; then
             echo "WAARSCHUWING: Bootloader of partities niet gevonden. We kunnen geen Factory Image maken."
             echo "We gaan alleen de OTA file uploaden."
             cp "$FIRMWARE" lumitone-ota.bin
             exit 0
          fi

          # Als we hier zijn, hebben we alles!
          echo "Alles compleet! We maken de Factory Image..."
          
          cp "$FIRMWARE" lumitone-ota.bin

          # Factory image samenstellen voor ESP32-S3
          python3 -m esptool --chip esp32s3 merge_bin \
            -o lumitone-factory.bin \
            --flash_mode dio \
            --flash_size 8MB \
            0x0000 "$BOOTLOADER" \
            0x8000 "$PARTITIONS" \
            0xe000 "$BOOT_APP0" \
            0x10000 "$FIRMWARE"

      - name: Calculate MD5 checksum
        run: |
          echo "MD5 checksums:"
          [ -f lumitone-ota.bin ] && md5sum lumitone-ota.bin
          [ -f lumitone-factory.bin ] && md5sum lumitone-factory.bin

      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            lumitone-ota.bin
            lumitone-factory.bin
