name: Build LumiTone Firmware

on:
  release:
    types: [published]

# Deze rechten zijn nodig om bestanden terug te mogen uploaden naar de release
permissions:
  contents: write

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # HIER ZAT DE FOUT: We gebruiken nu @v6 in plaats van @v4
      - name: Build ESPHome Firmware
        uses: esphome/build-action@v6
        id: esphome_build
        with:
          yaml_file: config/voice-factory.yaml
          version: latest

      # De output komt in de map 'config' te staan als 'voice-factory.bin'
      # We verplaatsen hem naar de hoofdmap en noemen hem 'lumitone-ota.bin'
      - name: Rename firmware
        run: |
          mv config/voice-factory.bin lumitone-ota.bin
          echo "Firmware verplaatst en hernoemd naar lumitone-ota.bin"

      # Print de MD5 hash voor je manifest.json
      - name: Calculate MD5 checksum
        run: |
          echo "Hier is je MD5 checksum voor de manifest:"
          md5sum lumitone-ota.bin

      # Upload de file naar de Release pagina
      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: lumitone-ota.bin
