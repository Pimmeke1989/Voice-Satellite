name: Build LumiTone Firmware

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. We installeren Python (de basis)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 2. We installeren ESPHome handmatig (zo omzeilen we de 'deprecated' fout)
      - name: Install ESPHome
        run: pip install esphome

      # 3. We voeren het compile commando direct uit
      - name: Build Firmware
        run: esphome compile config/voice-factory.yaml

      # 4. We zoeken het gemaakte bestand en hernoemen het
      # ESPHome verstopt de output diep in mappen, dus we gebruiken 'find' om hem te pakken
      - name: Locate and Rename Firmware
        run: |
          find config/.esphome/build -name "firmware.bin" -exec mv {} lumitone-ota.bin \;
          echo "Firmware gevonden en hernoemd naar lumitone-ota.bin"

      # 5. MD5 berekenen voor je manifest
      - name: Calculate MD5 checksum
        run: |
          echo "Hier is je MD5 checksum:"
          md5sum lumitone-ota.bin

      # 6. Uploaden naar de Release
      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: lumitone-ota.bin
